{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Reset Password - Smart College Bus Tracking{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center py-4">
                    <i class="fas fa-key fa-3x mb-3"></i>
                    <h3 class="mb-0">Reset Password</h3>
                    <p class="mb-0">Enter your email to reset your password</p>
                </div>
                <div class="card-body p-4 p-md-5">
                    {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <form method="POST" id="passwordResetForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="id_email" class="form-label">Email Address</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <input type="email" name="email" id="id_email" class="form-control" 
                                       placeholder="Enter your registered email" required>
                            </div>
                            <div class="form-text">
                                We'll send a password reset link to this email.
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i> Send Reset Link
                            </button>
                            <a href="{% url 'login' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i> Back to Login
                            </a>
                        </div>
                    </form>
                    
                    <div class="text-center mt-4">
                        <p class="text-muted mb-0">
                            Don't have an account? 
                            <a href="{% url 'register' %}" class="text-decoration-none">Sign up here</a>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="card shadow-sm mt-4">
                <div class="card-body">
                    <h6><i class="fas fa-info-circle me-2 text-info"></i> Instructions:</h6>
                    <ul class="small mb-0">
                        <li>Enter the email address associated with your account</li>
                        <li>Check your email for a password reset link</li>
                        <li>The link will expire in 24 hours for security</li>
                        <li>If you don't receive an email, check your spam folder</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#passwordResetForm').submit(function(e) {
        e.preventDefault();
        
        const email = $('#id_email').val();
        if (!email) {
            showAlert('danger', 'Please enter your email address.');
            return;
        }
        
        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showAlert('danger', 'Please enter a valid email address.');
            return;
        }
        
        // Disable submit button
        const submitBtn = $(this).find('button[type="submit"]');
        submitBtn.prop('disabled', true)
            .html('<i class="fas fa-spinner fa-spin me-2"></i>Sending...');
        
        // Submit form via AJAX
        $.ajax({
            url: '{% url "password_reset" %}',
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    showAlert('success', 'Password reset link sent! Check your email.');
                    $('#passwordResetForm')[0].reset();
                    
                    // Show success message
                    $('#passwordResetForm').html(`
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                            <h4>Email Sent!</h4>
                            <p class="text-muted mb-4">
                                We've sent a password reset link to <strong>${email}</strong>.
                                Please check your email and follow the instructions.
                            </p>
                            <div class="d-grid gap-2">
                                <a href="{% url 'login' %}" class="btn btn-primary">
                                    <i class="fas fa-sign-in-alt me-2"></i> Back to Login
                                </a>
                            </div>
                        </div>
                    `);
                } else {
                    showAlert('danger', response.message || 'Failed to send reset link.');
                    submitBtn.prop('disabled', false)
                        .html('<i class="fas fa-paper-plane me-2"></i> Send Reset Link');
                }
            },
            error: function(xhr) {
                let errorMessage = 'Failed to send reset link. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                showAlert('danger', errorMessage);
                submitBtn.prop('disabled', false)
                    .html('<i class="fas fa-paper-plane me-2"></i> Send Reset Link');
            }
        });
    });
});

function showAlert(type, message) {
    // Remove existing alerts
    $('.alert').remove();
    
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('.messages').html(alertHtml);
}
</script>
{% endblock %}