{% extends 'base.html' %}
{% load static %}

{% block title %}Track Bus - Smart College Bus Tracking{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-bus me-2"></i> Track Your Bus</h2>
                    <p class="text-muted mb-0">Live tracking of your assigned bus</p>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" id="refreshLocation">
                        <i class="fas fa-sync-alt me-2"></i> Refresh
                    </button>
                    <button class="btn btn-outline-success" id="shareLocation">
                        <i class="fas fa-share-alt me-2"></i> Share
                    </button>
                    <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#reportIssueModal">
                        <i class="fas fa-exclamation-triangle me-2"></i> Report Issue
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Bus Info & Controls -->
        <div class="col-lg-4 col-md-5 mb-4">
            <!-- Bus Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bus me-2"></i> Bus Information</h5>
                </div>
                <div class="card-body">
                    {% if bus %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="bus-icon me-3">
                            <i class="fas fa-bus-alt fa-3x text-primary"></i>
                        </div>
                        <div>
                            <h3 class="mb-1">{{ bus.bus_number }}</h3>
                            <span class="badge bg-{{ bus.get_status_color }}">{{ bus.get_status_display }}</span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-2">
                            <small class="text-muted">Driver</small>
                            <p class="mb-0 fw-bold">{{ bus.driver.get_full_name|default:"Not assigned" }}</p>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Capacity</small>
                            <p class="mb-0 fw-bold">{{ bus.current_occupancy|default:"0" }}/{{ bus.capacity }}</p>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Route</small>
                            <p class="mb-0 fw-bold">{{ bus.route.name|default:"No route assigned" }}</p>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Speed</small>
                            <p class="mb-0 fw-bold" id="currentSpeed">-- km/h</p>
                        </div>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">Current Location</small>
                        <p class="mb-0 fw-bold" id="currentLocation">Updating...</p>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">Next Stop</small>
                        <p class="mb-0 fw-bold" id="nextStop">Calculating...</p>
                        <small class="text-muted" id="nextStopDistance">Distance: -- km</small>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bus-slash fa-3x text-muted mb-3"></i>
                        <h5>No Bus Assigned</h5>
                        <p class="text-muted">You haven't been assigned to any bus yet.</p>
                        <a href="{% url 'buses:bus_list' %}" class="btn btn-primary">View Available Buses</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Estimated Arrival Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i> Estimated Arrival</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div id="countdownTimer" class="display-4 fw-bold text-primary">--:--</div>
                        <small class="text-muted">Time to your pickup</small>
                    </div>
                    
                    <div class="progress mb-3" style="height: 10px;">
                        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="fs-5 fw-bold" id="etaTime">--:--</div>
                                <small class="text-muted">ETA</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="fs-5 fw-bold" id="distance">-- km</div>
                                <small class="text-muted">Distance</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i> Live Updates</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="liveUpdates">
                        <div class="list-group-item">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-primary"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <small>Tracking started at <span id="lastUpdate">--:--</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="col-lg-8 col-md-7 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i> Live Tracking Map</h5>
                        <div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="liveTrackingToggle" checked>
                                <label class="form-check-label" for="liveTrackingToggle">Live Tracking</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0 position-relative">
                    <!-- Map Container -->
                    <div id="map" style="height: 600px; width: 100%;"></div>
                    
                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="btn btn-sm btn-light" id="zoomIn" title="Zoom In"><i class="fas fa-plus"></i></button>
                        <button class="btn btn-sm btn-light" id="zoomOut" title="Zoom Out"><i class="fas fa-minus"></i></button>
                        <button class="btn btn-sm btn-light" id="locateMe" title="Locate Me"><i class="fas fa-crosshairs"></i></button>
                        <button class="btn btn-sm btn-light" id="toggleTraffic" title="Traffic">
                            <i class="fas fa-traffic-light"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Route Details -->
    <div class="row mt-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-route me-2"></i> Route Details</h5>
                </div>
                <div class="card-body">
                    {% if route %}
                    <div class="timeline">
                        {% for stop in route.stops.all %}
                        <div class="timeline-item" data-stop-id="{{ stop.id }}">
                            <div class="timeline-marker">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">{{ stop.name }}</h6>
                                <small class="text-muted">{{ stop.address }}</small>
                                <div class="mt-1">
                                    <span class="badge bg-secondary stop-status">Upcoming</span>
                                    <small class="text-muted ms-2">ETA: <span class="stop-eta">--:--</span></small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No route information available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Issue Modal -->
<div class="modal fade" id="reportIssueModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="issueReportForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Report Issue</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Issue Type</label>
                        <select class="form-select" name="issue_type" required>
                            <option value="">Select issue type</option>
                            <option value="delay">Bus Delay</option>
                            <option value="crowded">Overcrowded</option>
                            <option value="breakdown">Breakdown</option>
                            <option value="driver">Driver Issue</option>
                            <option value="route">Wrong Route</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Please describe the issue..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Urgency Level</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="urgency" value="low" id="urgencyLow">
                            <label class="form-check-label" for="urgencyLow">
                                <span class="badge bg-success">Low</span> - Not urgent
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="urgency" value="medium" id="urgencyMedium" checked>
                            <label class="form-check-label" for="urgencyMedium">
                                <span class="badge bg-warning">Medium</span> - Somewhat urgent
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="urgency" value="high" id="urgencyHigh">
                            <label class="form-check-label" for="urgencyHigh">
                                <span class="badge bg-danger">High</span> - Requires immediate attention
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
#map {
    border-radius: 0 0 0.375rem 0.375rem;
}

.map-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.map-controls button {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.timeline {
    position: relative;
    padding-left: 40px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 25px;
}

.timeline-marker {
    position: absolute;
    left: -40px;
    top: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 3px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
}

.timeline-item.active .timeline-marker {
    background: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.timeline-item.completed .timeline-marker {
    background: #198754;
    border-color: #198754;
    color: white;
}

.timeline-content {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.stop-status {
    font-size: 0.75em;
}

.bus-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#liveUpdates {
    max-height: 200px;
    overflow-y: auto;
}

.list-group-item {
    border-left: none;
    border-right: none;
    padding: 10px 15px;
}
</style>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let busMarker;
let routeLine;
const busId = "{{ bus.id|default:'' }}";
const busData = {{ bus_data|default:"{}"|safe }};
const routeData = {{ route_data|default:"[]"|safe }};

$(document).ready(function() {
    // Initialize map
    initMap();
    
    // Initialize WebSocket for real-time updates
    if (busId) {
        initWebSocket();
        startLocationUpdates();
    }
    
    // Event Listeners
    $('#refreshLocation').click(refreshBusLocation);
    $('#liveTrackingToggle').change(toggleLiveTracking);
    $('#shareLocation').click(shareLocation);
    $('#zoomIn').click(() => map.zoomIn());
    $('#zoomOut').click(() => map.zoomOut());
    $('#locateMe').click(centerOnUser);
    $('#toggleTraffic').click(toggleTrafficLayer);
    
    // Issue report form
    $('#issueReportForm').submit(function(e) {
        e.preventDefault();
        reportIssue();
    });
});

function initMap() {
    // Default center (use college location or bus location)
    const defaultCenter = [12.9716, 77.5946]; // Default: Bangalore
    
    map = L.map('map').setView(defaultCenter, 13);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add route if available
    if (routeData && routeData.length > 0) {
        drawRoute(routeData);
    }
    
    // Add bus marker if location available
    if (busData && busData.latitude && busData.longitude) {
        updateBusMarker(busData);
    }
}

function initWebSocket() {
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${wsScheme}://${window.location.host}/ws/tracking/${busId}/`;
    
    try {
        const socket = new WebSocket(wsUrl);
        
        socket.onopen = function() {
            console.log('WebSocket connection established');
        };
        
        socket.onmessage = function(e) {
            try {
                const data = JSON.parse(e.data);
                handleWebSocketMessage(data);
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        socket.onclose = function() {
            console.log('WebSocket connection closed');
            setTimeout(initWebSocket, 5000); // Reconnect after 5 seconds
        };
        
        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
    }
}

function handleWebSocketMessage(data) {
    if (data.type === 'location_update') {
        updateBusLocation(data);
    } else if (data.type === 'status_update') {
        updateBusStatus(data);
    } else if (data.type === 'notification') {
        addLiveUpdate(data.message);
    }
}

function updateBusLocation(data) {
    const lat = data.latitude || data.lat;
    const lng = data.longitude || data.lng;
    
    if (!lat || !lng) return;
    
    if (!busMarker) {
        busMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'bus-marker',
                html: '<i class="fas fa-bus fa-2x text-danger"></i>',
                iconSize: [40, 40]
            })
        }).addTo(map);
    } else {
        busMarker.setLatLng([lat, lng]);
    }
    
    // Smooth pan to location
    map.panTo([lat, lng], { animate: true, duration: 1 });
    
    // Update info display
    $('#currentLocation').text(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
    $('#currentSpeed').text(`${data.speed || 0} km/h`);
    
    // Update last update time
    $('#lastUpdate').text(new Date().toLocaleTimeString());
}

function drawRoute(routePoints) {
    if (routeLine) {
        map.removeLayer(routeLine);
    }
    
    routeLine = L.polyline(routePoints, {
        color: '#0d6efd',
        weight: 4,
        opacity: 0.7,
        smoothFactor: 1
    }).addTo(map);
    
    // Fit map to route bounds
    if (routePoints.length > 0) {
        const bounds = L.latLngBounds(routePoints);
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

function updateBusStatus(data) {
    // Update bus status badge
    const statusBadge = $('.badge.bg-{{ bus.get_status_color }}');
    if (statusBadge.length) {
        statusBadge.text(data.status || 'Unknown');
        statusBadge.removeClass('bg-success bg-warning bg-danger bg-secondary');
        statusBadge.addClass(`bg-${data.status_color || 'secondary'}`);
    }
    
    // Update next stop info
    if (data.next_stop) {
        $('#nextStop').text(data.next_stop.name);
        $('#nextStopDistance').text(`Distance: ${data.distance_to_next || 0} km`);
        
        // Update ETA
        if (data.eta) {
            const etaTime = new Date(data.eta);
            $('#etaTime').text(etaTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            
            // Update countdown
            const now = new Date();
            const diffMs = etaTime - now;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins > 0) {
                $('#countdownTimer').text(`${diffMins} min`);
                const progress = Math.min(100, Math.max(0, 100 - (diffMins / 60 * 100)));
                $('#progressBar').css('width', `${progress}%`);
            }
        }
    }
}

function addLiveUpdate(message) {
    const updateTime = new Date().toLocaleTimeString();
    const updateHtml = `
        <div class="list-group-item">
            <div class="d-flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-info"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <p class="mb-1">${message}</p>
                    <small class="text-muted">${updateTime}</small>
                </div>
            </div>
        </div>
    `;
    
    $('#liveUpdates').prepend(updateHtml);
    
    // Keep only last 5 updates
    const updates = $('#liveUpdates .list-group-item');
    if (updates.length > 5) {
        updates.last().remove();
    }
}

function refreshBusLocation() {
    if (!busId) return;
    
    $('#refreshLocation').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...');
    
    $.ajax({
        url: `/api/bus/${busId}/location/`,
        method: 'GET',
        success: function(data) {
            updateBusLocation(data);
            $('#refreshLocation').html('<i class="fas fa-check me-2"></i>Updated');
            setTimeout(() => {
                $('#refreshLocation').html('<i class="fas fa-sync-alt me-2"></i>Refresh').prop('disabled', false);
            }, 2000);
        },
        error: function() {
            $('#refreshLocation').html('<i class="fas fa-times me-2"></i>Failed').prop('disabled', false);
        }
    });
}

function toggleLiveTracking() {
    const isEnabled = $('#liveTrackingToggle').is(':checked');
    if (isEnabled) {
        startLocationUpdates();
    } else {
        stopLocationUpdates();
    }
}

let updateInterval;
function startLocationUpdates() {
    if (updateInterval) clearInterval(updateInterval);
    updateInterval = setInterval(refreshBusLocation, 15000); // Update every 15 seconds
}

function stopLocationUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

function shareLocation() {
    if (!navigator.share) {
        // Fallback: Copy to clipboard
        navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
        return;
    }
    
    navigator.share({
        title: 'My Bus Location',
        text: `Bus ${busData.bus_number} is currently at ${$('#currentLocation').text()}`,
        url: window.location.href
    });
}

function centerOnUser() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                map.setView([position.coords.latitude, position.coords.longitude], 15);
            },
            (error) => {
                console.error('Geolocation error:', error);
                alert('Unable to get your location. Please enable location services.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

function toggleTrafficLayer() {
    alert('Traffic layer feature requires additional setup with traffic API.');
}

function reportIssue() {
    const formData = $('#issueReportForm').serialize();
    
    $.ajax({
        url: '/api/report-issue/',
        method: 'POST',
        data: formData,
        headers: {
            'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
        },
        beforeSend: function() {
            $('#issueReportForm button[type="submit"]').prop('disabled', true)
                .html('<i class="fas fa-spinner fa-spin me-2"></i>Submitting...');
        },
        success: function(response) {
            $('#reportIssueModal').modal('hide');
            showAlert('success', 'Issue reported successfully!');
            $('#issueReportForm')[0].reset();
        },
        error: function(xhr) {
            showAlert('danger', 'Failed to report issue. Please try again.');
        },
        complete: function() {
            $('#issueReportForm button[type="submit"]').prop('disabled', false)
                .html('Submit Report');
        }
    });
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.container-fluid').prepend(alertHtml);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}
</script>
{% endblock %}